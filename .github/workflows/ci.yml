name: CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  PYTHON_VERSION_DEFAULT: '3.11'

jobs:
  # =============================================================================
  # LINT JOB
  # =============================================================================
  lint:
    name: Code Quality & Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION_DEFAULT }}-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ env.PYTHON_VERSION_DEFAULT }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check code formatting with black
      run: black --check --diff src/ tests/

    - name: Check import sorting with isort
      run: isort --check-only --diff src/ tests/

    - name: Run flake8 linting
      run: flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503

  # =============================================================================
  # TYPE CHECK JOB
  # =============================================================================
  type-check:
    name: Static Type Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION_DEFAULT }}-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ env.PYTHON_VERSION_DEFAULT }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run mypy type checker
      run: mypy src/ --ignore-missing-imports

  # =============================================================================
  # TEST JOB - Matrix Strategy with Fail-Fast
  # =============================================================================
  test:
    name: Test Suite (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [lint, type-check]
    
    strategy:
      fail-fast: true  # Cancel all jobs if any job fails
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run tests with coverage
      run: |
        pytest \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junitxml=test-results.xml \
          -v
      env:
        # Mock environment variables for testing
        OPENROUTER_API_KEY: test-api-key-for-ci
        DEFAULT_MODEL: openai/gpt-3.5-turbo

    - name: Upload coverage report (HTML)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-html-py${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-py${{ matrix.python-version }}
        path: test-results.xml
        retention-days: 7

    - name: Upload coverage XML
      uses: actions/upload-artifact@v4
      if: matrix.python-version == env.PYTHON_VERSION_DEFAULT
      with:
        name: coverage-xml
        path: coverage.xml
        retention-days: 30

    - name: Generate coverage summary
      if: matrix.python-version == env.PYTHON_VERSION_DEFAULT
      run: |
        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        line_rate = float(root.attrib['line-rate']) * 100
        branch_rate = float(root.attrib['branch-rate']) * 100
        print(f'- Line Coverage: {line_rate:.2f}%')
        print(f'- Branch Coverage: {branch_rate:.2f}%')
        " >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # BUILD VERIFICATION JOB
  # =============================================================================
  build:
    name: Package Build Verification
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION_DEFAULT }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: python -m build

    - name: Check package with twine
      run: twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 7

  # =============================================================================
  # CI STATUS SUMMARY
  # =============================================================================
  ci-status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [lint, type-check, test, build]
    if: always()
    
    steps:
    - name: Check all jobs status
      run: |
        echo "## CI Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        
    - name: Fail if any job failed
      if: contains(needs.*.result, 'failure')
      run: |
        echo "❌ One or more jobs failed"
        exit 1
        
    - name: Success message
      if: ${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}
      run: |
        echo "✅ All CI checks passed!"
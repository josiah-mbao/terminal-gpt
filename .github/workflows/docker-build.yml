name: Docker Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - 'src/**'
      - 'pyproject.toml'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - 'src/**'
      - 'pyproject.toml'
      - 'requirements.txt'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =============================================================================
  # DOCKER BUILD AND VALIDATION
  # =============================================================================
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: terminal-gpt:test
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Test Docker image
      run: |
        echo "Testing Docker image..."
        docker run --rm terminal-gpt:test python --version
        docker run --rm terminal-gpt:test pip list | grep -E "(fastapi|uvicorn|rich|typer)"

    - name: Run container smoke test
      run: |
        echo "Running smoke tests..."
        # Test that the CLI works
        docker run --rm terminal-gpt:test python -m terminal_gpt --help || true
        # Test imports
        docker run --rm terminal-gpt:test python -c "from terminal_gpt.main import app; print('✅ Imports work')"

    - name: Save build logs
      if: always()
      run: |
        echo "Docker image built successfully" > docker-build.log
        docker images terminal-gpt:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> docker-build.log

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-build-logs
        path: docker-build.log
        retention-days: 7

  # =============================================================================
  # DOCKER SECURITY SCAN
  # =============================================================================
  docker-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: docker-build
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build image for scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: terminal-gpt:scan

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'terminal-gpt:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'terminal-gpt:scan'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: Upload scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-security-scan
        path: trivy-results.sarif
        retention-days: 30

  # =============================================================================
  # DOCKER COMPOSE VALIDATION
  # =============================================================================
  docker-compose-test:
    name: Docker Compose Test
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Compose
      run: |
        docker compose version

    - name: Build with Docker Compose
      run: |
        docker compose build

    - name: Test Docker Compose services
      run: |
        echo "Testing Docker Compose..."
        docker compose up -d
        sleep 5
        docker compose ps
        docker compose logs --tail=20
        docker compose down

    - name: Upload compose logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-compose-logs
        path: |
          docker-compose.log
        retention-days: 7

  # =============================================================================
  # STATUS SUMMARY
  # =============================================================================
  docker-status:
    name: Docker Pipeline Status
    runs-on: ubuntu-latest
    needs: [docker-build, docker-scan, docker-compose-test]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## Docker Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.docker-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Compose Test | ${{ needs.docker-compose-test.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check status
      if: contains(needs.*.result, 'failure')
      run: |
        echo "❌ Docker pipeline failed"
        exit 1